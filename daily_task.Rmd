---
title: "国立感染研の最新週報の処理"
output: html_document
date: "2025-4-16"
---

```{r}
library(tidyverse)
library(rvest)
library(lubridate)
```


```{r}

cleaned_diseases <- read_csv("merged_data/merged_data.csv")

# CSVファイルを処理する関数
process_csv <- function(file_path) {
  # 2行目1列目のテキストを読み込む（エンコーディングを指定）
  week_text <- read_csv(
    file_path, 
    locale = locale(encoding = "cp932"), 
    col_names = FALSE, 
    skip = 1, 
    n_max = 1
  ) %>%
    pull(1)
  
  # デバッグ情報を表示
  cat("Processing file:", file_path, "Week text:", week_text, "\n")
  
  # CSVファイルをすべて読み込み
  data <- read_csv(file_path, locale = locale(encoding = "cp932"), col_names = FALSE)
  
  # 3行目の奇数列（3列目以降）のNAを左隣の値で埋める
  data[3, ] <- data[3, ] %>%
    as.data.frame() %>%
    mutate(across(
      .cols = everything(),
      .fns = ~ {
        col_index <- which(names(data) == cur_column()) # 現在の列インデックスを取得
        if (col_index > 2 && col_index %% 2 == 1) { # 3列目以降かつ奇数列が対象
          ifelse(
            is.na(.), # NAか判定
            data[3, col_index - 1][[1]], # 左隣の値をコピー
            .
          )
        } else {
          . # 対象外の列はそのまま
        }
      }
    ))
  
  # 2列目以降の列名を作成（3行目と4行目を連結）
  new_col_names <- names(data) %>%
    map_chr(~ {
      col_index <- which(names(data) == .x) # 現在の列インデックスを取得
      if (col_index > 1) { # 2列目以降のみ処理
        paste0(data[3, col_index][[1]], "_", data[4, col_index][[1]])
      } else {
        .x # 1列目はそのまま
      }
    })
  
  # 列名を変更
  colnames(data) <- new_col_names
  
  # データの整形
  data <- data %>%
    slice(-1, -2, -3, -4) %>%  # 1～4行目を削除
    mutate(week = week_text) %>% # 新しい列として week を追加
    rename(pref = X1) %>% # 1列目を pref にリネーム
    pivot_longer(
      cols = -c(week, pref),
      names_to = "category",
      values_to = "value"
    )
  
  return(data)
}


year_week <- read_csv("year_week.csv") %>%
  mutate(date=as.Date(date))

# 今日の日付を取得
today <- Sys.Date()

# 9日前の日付
nine_days_before <- today - days(9)

# 9日前より以前で最新の日付を選択し、年・週ラベルを出力
closest_week <- year_week %>%
  filter(date <= nine_days_before) %>%
  tail(1) %>% 
  pull(year_week)


# 年と週に分割
parts <- strsplit(closest_week, "-")[[1]]
year <- parts[1]
week <- parts[2]

# URLを生成
url <- sprintf("https://id-info.jihs.go.jp/surveillance/idwr/jp/rapid/%s/%s/%s-teiten.csv", year, week, closest_week)

local_file <- sprintf("data/%s-teiten.csv", closest_week)  # ローカルに保存するファイル名

# 当該ファイルがないときにのみダウンロードを実行する
if (!file.exists(local_file)) {
  download.file(url, destfile = local_file, mode = "wb")
} else {
  message("ファイルは既に存在しています。")
}

# CSVファイルを読み込む
latest_data <- process_csv(local_file) %>% 
  mutate(year=as.double(str_sub(week,1,4))) %>% 
  mutate(week_num=str_sub(week,6,7)) %>% 
  mutate(date=as.Date(str_c(year,"-",str_sub(week,17,18),"-",str_sub(week,20,21)))) %>% 
  dplyr::select(date,year,pref,category,value,everything()) %>% 
  mutate(pref=ifelse(pref=="総数","全国",pref)) %>% 
  filter(!is.na(pref)) %>% 
      # 日付部分を列に展開
  bind_cols(
    str_match(.$week,
      "(\\d{4})年\\d+週\\((\\d{1,2})月(\\d{1,2})日～(\\d{1,2})月(\\d{1,2})日\\)"
    ) %>%
      as_tibble(.name_repair = "minimal") %>%
      setNames(c("full", "year_str", "m1", "d1", "m2", "d2"))
  ) %>%
  # 必要な列を整数に変換
  mutate(across(c(m1, d1, m2, d2), ~ as.integer(.))) %>%
  # ラベルを作成（条件付きで）
  mutate(week_label_clean = ifelse(
    is.na(year_str), NA_character_,
    sprintf("%d月%d日～%d月%d日（%s年）",
            m1, d1, m2, d2, year_str)
  )) %>%
  # 不要列削除
  dplyr::select(-full, -year_str, -m1, -d1, -m2, -d2) %>%
  # 以降の処理を継続
  filter(str_detect(category, "定当")) %>% 
  mutate(category = str_remove(category, "_定当")) %>% 
  dplyr::select(date, pref, category, value, year, week_label_clean) %>%
  mutate(value = as.double(value)) %>%
  filter(!(category == "ＲＳウイルス感染症" & is.na(value))) %>%
  mutate(value = ifelse(is.na(value), 0, value))


cleaned_diseases <- cleaned_diseases %>%
  bind_rows(latest_data) %>%
  distinct()

cleaned_diseases %>% 
  filter(pref=="全国") %>% 
  write_excel_csv("results/data-全国.csv")

cleaned_diseases %>% 
  filter(pref=="東京都") %>% 
  write_excel_csv("results/data-東京都.csv")

cleaned_diseases %>% 
  filter(!pref %in% c("全国","東京都")) %>% 
  write_excel_csv("results/data-その他.csv")

cleaned_diseases %>% 
  write_excel_csv("merged_data/merged_data.csv")
```

